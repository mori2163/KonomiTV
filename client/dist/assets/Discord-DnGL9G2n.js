import{d as p,co as c,M as d,a3 as E,cv as D,u as F,_ as A,k as C,h as o,b as u,w as y,a as n,c as _,r as f,l as t,cw as v,n as l,V as S,o as a,R as h}from"./index-D826gnrH.js";import{S as w}from"./Base-O817hR_u.js";import{V as m}from"./VSwitch-CdO8PmIU.js";import{b as B}from"./VTextField-DBc2Ub5g.js";import"./Navigation-Bydd3YIF.js";import"./ssrBoot-HaBCASlw.js";import"./VSelectionControl-BaoJS_1J.js";import"./transition-CRwuXupp.js";const V=p({name:"Settings-Discord",components:{SettingsBase:w},setup(){return{settingsStore:F()}},data(){return{discord_connected:!1,show_token:!1,server_settings:JSON.parse(JSON.stringify(D)),original_server_settings:JSON.parse(JSON.stringify(D)),is_admin:!1,saving:!1}},computed:{hasChanges(){return JSON.stringify(this.server_settings)!==JSON.stringify(this.original_server_settings)},channelIdRules(){return[e=>{if(!e||e==="")return!0;if(!/^\d+$/.test(e))return"チャンネルIDは数字のみで入力してください";if(e.length<17||e.length>19)return"チャンネルIDは17～19桁で入力してください";try{if(BigInt(e)<0)return"チャンネルIDは正の数値である必要があります"}catch{return"無効なチャンネルIDです"}return!0}]}},async mounted(){await this.loadSettings()},async activated(){await this.loadSettings()},methods:{async loadSettings(){const s=await E().fetchUser();this.is_admin=(s==null?void 0:s.is_admin)||!1;const r=await c.fetchServerSettings();r?(r.discord.channel_id!==null&&(r.discord.channel_id=String(r.discord.channel_id)),this.server_settings=r,this.original_server_settings=JSON.parse(JSON.stringify(r)),this.settingsStore.settings.discord.enabled=r.discord.enabled,this.settingsStore.settings.discord.notify_server=r.discord.notify_server,this.settingsStore.settings.discord.notify_recording=r.discord.notify_recording):d.error("サーバー設定を取得できませんでした。"),await this.checkConnection()},async checkConnection(){try{const e=await c.fetchDiscordStatus();this.discord_connected=e.connected}catch{this.discord_connected=!1}},async updateDiscordSettings(){this.saving=!0;try{this.server_settings.discord.channel_id!==null&&this.server_settings.discord.channel_id!==""&&(this.server_settings.discord.channel_id=String(this.server_settings.discord.channel_id)),await c.updateServerSettings(this.server_settings)===!0?(await this.loadSettings(),d.success(`Discord設定を更新しました。
変更を反映するためには、KonomiTV サーバーを再起動してください。`)):d.error("Discord設定の更新に失敗しました。")}catch(e){console.error("Discord settings update failed:",e),d.error("Discord設定の更新に失敗しました。")}finally{this.saving=!1}}}}),k={class:"settings__heading"},I={class:"settings__content"},N={class:"settings__item settings__item--switch"},$={class:"settings__item"},J={class:"settings__item-label"},O={key:0,class:"d-flex align-center"},T={key:1,class:"d-flex align-center"};function U(e,s,r,R,K,M){const g=f("Icon"),b=f("SettingsBase");return a(),C(b,null,{default:o(()=>[u("h2",k,[y((a(),_("a",{class:"settings__back-button",onClick:s[0]||(s[0]=i=>e.$router.back())},[n(g,{icon:"fluent:chevron-left-12-filled",width:"27px"})])),[[h]]),n(g,{icon:"fa-brands:discord",width:"19px",style:{margin:"0 4px"}}),s[8]||(s[8]=u("span",{class:"ml-3"},"Discord連携",-1))]),u("div",I,[u("div",N,[s[9]||(s[9]=u("label",{class:"settings__item-heading",for:"discord_enabled"},"Discord連携機能を有効にする",-1)),s[10]||(s[10]=u("label",{class:"settings__item-label",for:"discord_enabled"},[t(" KonomiTVとDiscordを連携すると、各種通知をDiscordに送信できるようになります。"),u("br"),t(" 使用するにはDiscord Botのトークンの設定が必要です。"),u("br")],-1)),n(m,{class:"settings__item-switch",color:"primary",id:"discord_enabled","hide-details":"",disabled:!e.is_admin,modelValue:e.server_settings.discord.enabled,"onUpdate:modelValue":s[1]||(s[1]=i=>e.server_settings.discord.enabled=i)},null,8,["disabled","modelValue"])]),u("div",$,[s[15]||(s[15]=u("div",{class:"settings__item-heading"},"Discord接続状態",-1)),u("div",J,[e.discord_connected?(a(),_("div",O,[n(v,{color:"success",class:"mr-2"},{default:o(()=>s[11]||(s[11]=[t("mdi-check-circle")])),_:1}),s[12]||(s[12]=u("span",null,"Botが正常に接続されています",-1))])):(a(),_("div",T,[n(v,{color:"error",class:"mr-2"},{default:o(()=>s[13]||(s[13]=[t("mdi-alert-circle")])),_:1}),s[14]||(s[14]=u("span",null,"Botが接続されていません。Bot Tokenを確認してください。",-1))]))])]),u("div",{class:l(["settings__item",{"settings__content--disabled":!e.is_admin||!e.server_settings.discord.enabled}])},[s[16]||(s[16]=u("div",{class:"settings__item-heading"},"Discord Bot Token",-1)),s[17]||(s[17]=u("div",{class:"settings__item-label"},[t(" Discord Botのトークンを入力してください。"),u("br"),t(" トークンはDiscordの開発者ポータルで取得できます。"),u("br")],-1)),n(B,{class:"settings__item-form",color:"primary",variant:"outlined","hide-details":"",modelValue:e.server_settings.discord.token,"onUpdate:modelValue":s[2]||(s[2]=i=>e.server_settings.discord.token=i),disabled:!e.is_admin||!e.server_settings.discord.enabled,"append-icon":e.show_token?"mdi-eye":"mdi-eye-off",type:e.show_token?"text":"password",placeholder:"Discord Bot Token","onClick:append":s[3]||(s[3]=i=>e.show_token=!e.show_token)},null,8,["modelValue","disabled","append-icon","type"])],2),u("div",{class:l(["settings__item",{"settings__content--disabled":!e.is_admin||!e.server_settings.discord.enabled}])},[s[18]||(s[18]=u("div",{class:"settings__item-heading"},"通知チャンネルID",-1)),s[19]||(s[19]=u("div",{class:"settings__item-label"},[t(" 通知を送信するDiscordチャンネルのIDを入力してください。"),u("br"),t(" チャンネルIDはDiscordのチャンネルを右クリック→IDをコピーで取得できます。"),u("br")],-1)),n(B,{class:"settings__item-form",color:"primary",variant:"outlined",modelValue:e.server_settings.discord.channel_id,"onUpdate:modelValue":s[4]||(s[4]=i=>e.server_settings.discord.channel_id=i),disabled:!e.is_admin||!e.server_settings.discord.enabled,placeholder:"例: 123456789012345678",type:"text",rules:e.channelIdRules,"hide-details":"auto"},null,8,["modelValue","disabled","rules"])],2),u("div",{class:l(["settings__item settings__item--switch",{"settings__content--disabled":!e.server_settings.discord.enabled}])},[s[20]||(s[20]=u("label",{class:"settings__item-heading",for:"discord_notify_server"},"起動/終了の通知",-1)),s[21]||(s[21]=u("label",{class:"settings__item-label",for:"discord_notify_server"},[t(" サーバーの起動時と終了時に通知を送信します。"),u("br"),t(" 通知が不要な場合は、この設定をオフにできます。"),u("br")],-1)),n(m,{class:"settings__item-switch",color:"primary",id:"discord_notify_server","hide-details":"",disabled:!e.server_settings.discord.enabled,modelValue:e.server_settings.discord.notify_server,"onUpdate:modelValue":s[5]||(s[5]=i=>e.server_settings.discord.notify_server=i)},null,8,["disabled","modelValue"])],2),u("div",{class:l(["settings__item settings__item--switch",{"settings__content--disabled":!e.server_settings.discord.enabled}])},[s[22]||(s[22]=u("label",{class:"settings__item-heading",for:"discord_notify_recording"},"録画予約/完了の通知",-1)),s[23]||(s[23]=u("label",{class:"settings__item-label",for:"discord_notify_recording"},[t(" 録画予約の開始時と完了時に通知を送信します。"),u("br"),t(" 通知が不要な場合は、この設定をオフにできます。"),u("br")],-1)),n(m,{class:"settings__item-switch",color:"primary",id:"discord_notify_recording","hide-details":"",disabled:!e.server_settings.discord.enabled,modelValue:e.server_settings.discord.notify_recording,"onUpdate:modelValue":s[6]||(s[6]=i=>e.server_settings.discord.notify_recording=i)},null,8,["disabled","modelValue"])],2),s[25]||(s[25]=u("div",{class:"settings__description mt-3"},[t(" 設定を変更した場合は、[Discord設定を更新] ボタンを押して保存してください。"),u("br"),t(" 変更を反映するには KonomiTV サーバーの再起動が必要です。"),u("br")],-1)),n(S,{class:"settings__save-button bg-secondary mt-6",variant:"flat",onClick:s[7]||(s[7]=i=>e.updateDiscordSettings())},{default:o(()=>[n(g,{icon:"fluent:save-16-filled",class:"mr-2",height:"23px"}),s[24]||(s[24]=t("Discord設定を更新 "))]),_:1})])]),_:1})}const W=A(V,[["render",U]]);export{W as default};
