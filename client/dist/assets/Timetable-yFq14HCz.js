import{H as ue,N as me}from"./Navigation-Ctrd38eO.js";import{S as _e}from"./SPHeaderBar-B4jeJjTS.js";import{d as ae,q as w,s as re,x as se,c as l,b as r,n as ee,e as P,w as ge,t as _,a as u,y as f,I as te,k as S,h as m,z as j,F as y,g as D,V as x,l as v,A as M,o as i,R as fe,_ as ne,B as T,C as ve,D as pe,E as R,G as he,f as V,H as be,J as ye,K as we}from"./index-CQ2c3tog.js";import{R as Q}from"./Reservations-oWQw_IvY.js";import{V as ke}from"./VTooltip-DxuOaqiO.js";import"./ssrBoot-B7k1dIYN.js";import"./VOverlay-BMoQDq53.js";import"./forwardRefs-B931MWyl.js";const De={class:"timetable-program-detail-drawer__header"},xe={key:0,class:"timetable-program-detail-drawer__header-body"},Pe={class:"timetable-program-detail-drawer__title"},Se={class:"timetable-program-detail-drawer__period"},Ce={key:1,class:"timetable-program-detail-drawer__header-body"},Ee={key:0,class:"timetable-program-detail-drawer__content"},$e={class:"timetable-program-detail-drawer__badges"},Ge={class:"timetable-program-detail-drawer__section"},Te={class:"timetable-program-detail-drawer__description"},Re={key:0,class:"timetable-program-detail-drawer__section"},Ve={class:"timetable-program-detail-drawer__detail-grid"},Be={class:"timetable-program-detail-drawer__detail-key"},ze={class:"timetable-program-detail-drawer__detail-value"},He={key:1,class:"timetable-program-detail-drawer__empty"},Me={key:2,class:"timetable-program-detail-drawer__footer"},Ie={class:"timetable-program-detail-drawer__actions"},Le=ae({__name:"ProgramDetailDrawer",props:{modelValue:{type:Boolean},program:{},isReserved:{type:Boolean},isReserving:{type:Boolean}},emits:["update:modelValue","reserve","remove"],setup(e,{emit:a}){const n=e,p=a,C=w({get:()=>n.modelValue,set:g=>p("update:modelValue",g)}),A=w(()=>n.program?n.program.genres.slice(0,2).map(g=>g.major):[]),O=w(()=>{var o;const g=(o=n.program)==null?void 0:o.video_resolution;return g==="1080i"||g==="1080p"}),Y=w(()=>n.program?Object.keys(n.program.detail??{}).length>0:!1),k=g=>{const o=new Date(g),h=o.getFullYear(),E=String(o.getMonth()+1).padStart(2,"0"),J=String(o.getDate()).padStart(2,"0"),K=String(o.getHours()).padStart(2,"0"),z=String(o.getMinutes()).padStart(2,"0");return`${h}/${E}/${J} ${K}:${z}`},q=w(()=>{if(!n.program)return"";const g=k(n.program.start_time),o=k(n.program.end_time),h=Math.floor(n.program.duration/60);return`${g} - ${o} (${h}分)`});re(C,g=>{g?document.documentElement.classList.add("v-overlay-scroll-blocked"):document.documentElement.classList.remove("v-overlay-scroll-blocked")},{immediate:!0}),se(()=>{document.documentElement.classList.remove("v-overlay-scroll-blocked")});const B=()=>{p("update:modelValue",!1)},I=()=>{!n.program||n.isReserving||p("reserve",n.program.id)},U=()=>{!n.program||n.isReserving||p("remove",n.program.id)};return(g,o)=>(i(),l("div",null,[r("div",{class:ee(["timetable-program-detail-drawer__scrim",{"timetable-program-detail-drawer__scrim--visible":C.value}]),onClick:B},null,2),r("div",{class:ee(["timetable-program-detail-drawer",{"timetable-program-detail-drawer--visible":C.value}])},[r("div",De,[e.program?(i(),l("div",xe,[r("h2",Pe,_(e.program.title),1),r("p",Se,_(q.value),1)])):(i(),l("div",Ce,[...o[0]||(o[0]=[r("h2",{class:"timetable-program-detail-drawer__title"}," 番組情報を取得できませんでした ",-1)])])),ge((i(),l("div",{class:"timetable-program-detail-drawer__close",onClick:B},[u(f(te),{icon:"fluent:dismiss-16-filled",width:"22px",height:"22px"})])),[[fe]])]),e.program?(i(),l("div",Ee,[r("div",$e,[e.isReserved?(i(),S(j,{key:0,color:"error",size:"small",variant:"flat",class:"mr-2 mb-2"},{default:m(()=>[u(M,{start:""},{default:m(()=>[...o[1]||(o[1]=[v("mdi-record-circle",-1)])]),_:1}),o[2]||(o[2]=v(" 録画予約済み ",-1))]),_:1})):P("",!0),e.program.is_free?P("",!0):(i(),S(j,{key:1,color:"warning",size:"small",variant:"flat",class:"mr-2 mb-2"},{default:m(()=>[u(M,{start:""},{default:m(()=>[...o[3]||(o[3]=[v("mdi-currency-yen",-1)])]),_:1}),o[4]||(o[4]=v(" 有料放送 ",-1))]),_:1})),O.value?(i(),S(j,{key:2,color:"success",size:"small",variant:"flat",class:"mr-2 mb-2"},{default:m(()=>[u(M,{start:""},{default:m(()=>[...o[5]||(o[5]=[v("mdi-high-definition",-1)])]),_:1}),o[6]||(o[6]=v(" HD ",-1))]),_:1})):P("",!0),(i(!0),l(y,null,D(A.value,h=>(i(),S(j,{key:h,color:"primary",variant:"outlined",size:"small",class:"mr-2 mb-2"},{default:m(()=>[v(_(h),1)]),_:2},1024))),128))]),r("section",Ge,[o[7]||(o[7]=r("h3",{class:"timetable-program-detail-drawer__section-title"},"番組内容",-1)),r("p",Te,_(e.program.description||"番組説明が登録されていません。"),1)]),Y.value?(i(),l("section",Re,[o[8]||(o[8]=r("h3",{class:"timetable-program-detail-drawer__section-title"},"詳細情報",-1)),r("div",Ve,[(i(!0),l(y,null,D(e.program.detail,(h,E)=>(i(),l("div",{key:E,class:"timetable-program-detail-drawer__detail-item"},[r("span",Be,_(E)+":",1),r("span",ze,_(h),1)]))),128))])])):P("",!0)])):(i(),l("div",He," 番組情報の読み込みに失敗しました。 ")),e.program?(i(),l("div",Me,[r("div",Ie,[e.isReserved?(i(),S(x,{key:1,color:"error",variant:"flat",class:"px-4",loading:e.isReserving,onClick:U},{default:m(()=>[u(f(te),{icon:"fluent:delete-16-regular",width:"20px",height:"20px"}),o[10]||(o[10]=r("span",{class:"ml-2"},"予約削除",-1))]),_:1},8,["loading"])):(i(),S(x,{key:0,color:"primary",variant:"flat",class:"px-4",loading:e.isReserving,onClick:I},{default:m(()=>[...o[9]||(o[9]=[v(" 録画予約 ",-1)])]),_:1},8,["loading"])),u(x,{variant:"text",color:"text",class:"px-4",onClick:B},{default:m(()=>[...o[11]||(o[11]=[v(" 閉じる ",-1)])]),_:1})])])):P("",!0)],2)]))}}),Ne=ne(Le,[["__scopeId","data-v-628b0a03"]]);let W=class{static async fetchTimetable(a,n){const p=await T.get("/timetable",{params:{start_time:a.toISOString(),end_time:n.toISOString()}});return p.type==="error"?(T.showGenericError(p,"番組表の情報を取得できませんでした。"),null):p.data}static async updateEPG(){const a=await T.post("/timetable/update-epg");return a.type==="error"?(T.showGenericError(a,"EPG の取得に失敗しました。"),!1):!0}static async reloadEPG(){const a=await T.post("/timetable/reload-epg");return a.type==="error"?(T.showGenericError(a,"EPG の再読み込みに失敗しました。"),!1):!0}};const Fe=ve("timetable",{state:()=>({_timetable_channels:null,current_date:new Date,selected_channel_type:"ALL",is_loading:!1,reserved_program_ids:[],program_id_to_reservation_id:{}}),getters:{timetable_channels(e){return e._timetable_channels?e.selected_channel_type==="ALL"?e._timetable_channels:e._timetable_channels.filter(a=>a.channel.type===e.selected_channel_type):null}},actions:{async fetchReservations(){try{const e=await Q.fetchReservations();if(console.log("[TimetableStore] 録画予約情報を取得:",e),e){this.reserved_program_ids=e.reservations.map(n=>n.program.id);const a={};for(const n of e.reservations)a[n.program.id]=n.id;this.program_id_to_reservation_id=a}else this.reserved_program_ids=[],this.program_id_to_reservation_id={}}catch{this.reserved_program_ids=[],this.program_id_to_reservation_id={}}},async fetchTimetable(){if(this.is_loading)return;this.is_loading=!0;const e=new Date(this.current_date);e.setHours(4,0,0,0);const a=new Date(e);a.setDate(a.getDate()+1);try{const[n]=await Promise.all([W.fetchTimetable(e,a),this.fetchReservations()]);this._timetable_channels=n}catch(n){console.error(n),this._timetable_channels=null}finally{this.is_loading=!1}},setPreviousDate(){const e=new Date(this.current_date);e.setDate(e.getDate()-1),this.current_date=e,this.fetchTimetable()},setNextDate(){const e=new Date(this.current_date);e.setDate(e.getDate()+1),this.current_date=e,this.fetchTimetable()},setCurrentDate(){this.current_date=new Date,this.fetchTimetable()},setChannelType(e){this.selected_channel_type=e},async updateEPG(){if(!this.is_loading){this.is_loading=!0;try{if(!await W.updateEPG())throw new Error("EPGの取得に失敗しました。");await this.fetchTimetable()}catch(e){throw console.error("EPG 取得エラー:",e),e}finally{this.is_loading=!1}}},async reloadEPG(){if(!this.is_loading){this.is_loading=!0;try{if(!await W.reloadEPG())throw new Error("EPGの再読み込みに失敗しました。");await this.fetchTimetable()}catch(e){throw console.error("EPG再読み込みエラー:",e),e}finally{this.is_loading=!1}}}}}),je={class:"route-container"},Ae={class:"timetable-container-wrapper"},Oe={class:"timetable-header"},Ye={class:"channels-tab"},qe={class:"timetable-header__date-control"},Ue={class:"mx-4 date-display"},Je={class:"timetable-body"},Ke={key:0,class:"loading-container"},We={key:1,class:"timetable-grid-container"},Qe={class:"timeline-container"},Xe={class:"hour-text"},Ze=["onClick"],et={class:"program-header"},tt={class:"program-title"},at={class:"program-badges"},rt={key:0,class:"program-badge program-badge--paid"},st={key:1,class:"program-badge program-badge--genre"},nt={key:0,class:"program-description"},ot={class:"program-time"},it={class:"tooltip-text"},lt={key:2,class:"loading-container"},dt={class:"epg-controls-floating"},ct=ae({__name:"Timetable",setup(e){const a=Fe(),n=pe(),p=[{id:"ALL",name:"すべて"},{id:"GR",name:"地デジ"},{id:"BS",name:"BS"},{id:"CS",name:"CS"}],C=R(0),A=(t,s)=>{a.setChannelType(t),C.value=s},O={"ニュース・報道":{background:"#5a88a7",text:"#ffffff"},スポーツ:{background:"#e07f5a",text:"#ffffff"},"情報・ワイドショー":{background:"#e7a355",text:"#ffffff"},ドラマ:{background:"#b464a8",text:"#ffffff"},音楽:{background:"#64b46e",text:"#ffffff"},バラエティ:{background:"#e05a8e",text:"#ffffff"},映画:{background:"#a7647e",text:"#ffffff"},"アニメ・特撮":{background:"#e76b55",text:"#ffffff"},"ドキュメンタリー・教養":{background:"#5a88a7",text:"#ffffff"},"劇場・公演":{background:"#a7647e",text:"#ffffff"},"趣味・教育":{background:"#64b46e",text:"#ffffff"},福祉:{background:"#5aa788",text:"#ffffff"},その他:{background:"#7f7f7f",text:"#ffffff"}},Y={background:"rgb(var(--v-theme-background-lighten-3))",text:"rgb(var(--v-theme-text))"},k=R(new Date),q=setInterval(()=>{k.value=new Date},60*1e3);se(()=>{clearInterval(q)});const B=w(()=>{const t=a.current_date,s=t.getFullYear(),d=t.getMonth()+1,b=t.getDate(),c=["日","月","火","水","木","金","土"][t.getDay()];return`${s}年${d}月${b}日 (${c})`}),I=t=>{const s=new Date(t);return`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`},U=(t,s)=>t.length<=s?t:t.substring(0,s)+"...",g=w(()=>{var t;return{"grid-template-columns":`repeat(${((t=a.timetable_channels)==null?void 0:t.length)||0}, minmax(200px, 1fr))`}}),o=(t,s)=>{var Z;const d=new Date(t.start_time),b=(d.getHours()-4+24)%24*60+d.getMinutes(),c=t.duration/60,G=((Z=t.genres[0])==null?void 0:Z.major)||"その他",N=O[G]||Y,F={"grid-column":s+1,"grid-row-start":b+1,"grid-row-end":b+c+1,"background-color":N.background,color:N.text};return z(t.id)||(F["border-color"]=N.background),new Date(t.end_time)<k.value&&(F.opacity=.6,F["pointer-events"]="none"),F},h=w(()=>{const t=new Date,s=a.current_date;return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}),E=w(()=>({top:`${((k.value.getHours()-4+24)%24*60+k.value.getMinutes())*2}px`})),J=t=>t.duration/60>15,K=w(()=>new Set(a.reserved_program_ids)),z=t=>K.value.has(t),H=R(!1),L=R(null),oe=t=>{L.value=t,H.value=!0},$=R(!1),ie=async t=>{$.value=!0;const s={is_enabled:!0,priority:3,recording_folders:[],recording_start_margin:null,recording_end_margin:null,recording_mode:"SpecifiedService",caption_recording_mode:"Default",data_broadcasting_recording_mode:"Default",post_recording_mode:"Default",post_recording_bat_file_path:null,is_event_relay_follow_enabled:!0,is_exact_recording_enabled:!1,is_oneseg_separate_output_enabled:!1,is_sequential_recording_in_single_file_enabled:!1,forced_tuner_id:null};await Q.addReservation(t,s)?(n.show("success","録画予約を追加しました。"),H.value=!1,await a.fetchReservations()):n.show("error","録画予約の追加に失敗しました。"),$.value=!1},le=async t=>{$.value=!0;const s=a.program_id_to_reservation_id[t];if(!s){n.show("error","録画予約情報が見つかりませんでした。"),$.value=!1;return}await Q.deleteReservation(s)?(n.show("success","録画予約を削除しました。"),H.value=!1,await a.fetchReservations()):n.show("error","録画予約の削除に失敗しました。"),$.value=!1},de=async()=>{try{await a.updateEPG(),n.show("success","EPG 取得を開始しました。")}catch(t){n.show("error","EPG 取得に失敗しました。EDCBが起動していることを確認してください。"),console.error("EPG 取得エラー:",t)}},ce=async()=>{try{await a.reloadEPG(),n.show("success","EPG を再読み込みしました。")}catch(t){n.show("error","EPG の再読み込みに失敗しました。EDCBが起動していることを確認してください。"),console.error("EPG再読み込みエラー:",t)}};he(()=>{a.fetchTimetable()});const X=R(!0);return re(()=>a.timetable_channels,t=>{X.value&&t&&t.length>0&&we(()=>{const s=document.querySelector(".timetable-grid-container");if(!s)return;const d=k.value.getHours(),b=k.value.getMinutes(),G=((d-4+24-1)%24*60+b)*2-50;s.scrollTo({top:G>0?G:0,behavior:"smooth"}),X.value=!1})}),(t,s)=>(i(),l("div",je,[u(ue),r("main",null,[u(me),r("div",Ae,[u(_e),r("div",Oe,[r("div",Ye,[r("div",{class:"channels-tab__buttons",style:V({"--tab-length":p.length,"--active-tab-index":C.value})},[(i(),l(y,null,D(p,(d,b)=>u(x,{variant:"flat",class:"channels-tab__button",key:d.id,onClick:c=>A(d.id,b)},{default:m(()=>[v(_(d.name),1)]),_:2},1032,["onClick"])),64)),s[1]||(s[1]=r("div",{class:"channels-tab__highlight"},null,-1))],4)]),r("div",qe,[u(x,{onClick:f(a).setPreviousDate,class:"mr-2"},{default:m(()=>[...s[2]||(s[2]=[v("前日",-1)])]),_:1},8,["onClick"]),r("h2",Ue,_(B.value),1),u(x,{onClick:f(a).setNextDate,class:"ml-2"},{default:m(()=>[...s[3]||(s[3]=[v("翌日",-1)])]),_:1},8,["onClick"]),u(x,{onClick:f(a).setCurrentDate,class:"ml-4"},{default:m(()=>[...s[4]||(s[4]=[v("今日",-1)])]),_:1},8,["onClick"])])]),r("div",Je,[f(a).is_loading?(i(),l("div",Ke,[u(be,{indeterminate:"",size:"64"})])):f(a).timetable_channels&&f(a).timetable_channels.length>0?(i(),l("div",We,[s[5]||(s[5]=r("div",{class:"corner-cell"},null,-1)),r("div",{class:"channels-header",style:V(g.value)},[(i(!0),l(y,null,D(f(a).timetable_channels,d=>(i(),l("div",{key:d.channel.id,class:"channel-header-cell"},_(d.channel.name),1))),128))],4),r("div",Qe,[(i(),l(y,null,D(25,d=>r("div",{key:d,class:"hour-label"},[r("span",Xe,_((d+3)%24),1)])),64))]),r("div",{class:"programs-grid",style:V(g.value)},[h.value?(i(),l("div",{key:0,class:"current-time-line",style:V(E.value)},null,4)):P("",!0),(i(!0),l(y,null,D(f(a).timetable_channels.length,d=>(i(),l("div",{key:d,class:"channel-border",style:V({gridColumn:d})},null,4))),128)),(i(),l(y,null,D(24,d=>r("div",{key:d,class:"hour-border",style:V({gridRow:d*60+1})},null,4)),64)),(i(!0),l(y,null,D(f(a).timetable_channels,(d,b)=>(i(),l(y,null,[(i(!0),l(y,null,D(d.programs,c=>(i(),S(ke,{key:c.id,location:"top",disabled:J(c)},{activator:m(({props:G})=>[r("div",ye({ref_for:!0},G,{class:["program-cell elevation-2",{"program-cell--reserved":z(c.id)}],style:o(c,b),onClick:N=>oe(c)}),[r("div",et,[r("div",tt,_(c.title),1),r("div",at,[c.is_free?P("",!0):(i(),l("span",rt,"有料")),c.genres.length>0?(i(),l("span",st,_(c.genres[0].major),1)):P("",!0)])]),c.description&&c.duration>=900?(i(),l("div",nt,_(U(c.description,50)),1)):P("",!0),r("div",ot,_(I(c.start_time))+" - "+_(I(c.end_time))+" ("+_(Math.floor(c.duration/60))+"分)",1)],16,Ze)]),default:m(()=>[r("span",it,_(c.title),1)]),_:2},1032,["disabled"]))),128))],64))),256))],4)])):(i(),l("div",lt,[...s[6]||(s[6]=[r("p",null,"番組情報を取得できませんでした。",-1),r("p",null,"指定された期間・チャンネルに放送される番組がありません。",-1)])]))])])]),r("div",dt,[u(x,{onClick:de,loading:f(a).is_loading,disabled:f(a).is_loading,color:"primary",variant:"tonal",size:"large",class:"epg-btn"},{default:m(()=>[u(M,{icon:"mdi-download",class:"mr-1",size:"large"}),s[7]||(s[7]=r("span",null,"EPG取得",-1))]),_:1},8,["loading","disabled"]),u(x,{onClick:ce,loading:f(a).is_loading,disabled:f(a).is_loading,color:"secondary",variant:"tonal",size:"large",class:"epg-btn"},{default:m(()=>[u(M,{icon:"mdi-refresh",class:"mr-1",size:"large"}),s[8]||(s[8]=r("span",null,"EPG再読み込み",-1))]),_:1},8,["loading","disabled"])]),u(Ne,{modelValue:H.value,"onUpdate:modelValue":s[0]||(s[0]=d=>H.value=d),program:L.value,"is-reserved":L.value?z(L.value.id):!1,"is-reserving":$.value,onReserve:ie,onRemove:le},null,8,["modelValue","program","is-reserved","is-reserving"])]))}}),yt=ne(ct,[["__scopeId","data-v-8f925dfc"]]);export{yt as default};
