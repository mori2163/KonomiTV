import{d as _e,a2 as ve,u as pe,L as ge,E as c,q as O,U as x,G as we,c as d,b as l,a as o,e as T,h as n,z as S,V as p,y as f,Z as ye,I as _,t as i,H as he,F as P,g as be,M as v,aZ as I,a_ as Ve,l as m,n as A,a$ as De,W as E,O as ke,o as u,_ as Ce}from"./index-DJnqFb91.js";import{B as xe}from"./Breadcrumbs-DyjOTM-C.js";import{H as Te,N as Se}from"./Navigation-Dma7GRf8.js";import{S as He}from"./SPHeaderBar-L3CPa1ez.js";import{O as L}from"./manager-B_l_qcot.js";import{V as ze}from"./Videos-y6WHFsfm.js";import{V as Ue}from"./VTextField-BzKJGGL0.js";import{V as Q}from"./VSelect-BEmwMWVE.js";import{V as $e}from"./VDialog-DAC-RvNQ.js";import{V as Be,a as Me,b as Oe,c as Pe}from"./VCard-CCKEmTaz.js";import{V as G}from"./VSwitch-D2sK-9NJ.js";import{P as Ie}from"./PlayerUtils-BfTyTGZ4.js";import"./ssrBoot-DvxYJLiV.js";import"./forwardRefs-B931MWyl.js";import"./dialog-transition-CY4dbePS.js";import"./VOverlay-BcNliwIL.js";import"./VDivider-TTn6AwhD.js";const Ee={class:"route-container"},Le={class:"offline-container-wrapper"},Re={class:"offline-container"},Ye={class:"offline-toolbar"},Ne={class:"offline-toolbar__headline"},Fe={class:"offline-toolbar__actions"},je={key:0,class:"offline-alert"},qe={key:1,class:"offline-summary"},Ae={class:"offline-list"},Qe={key:0,class:"offline-list__loading"},Ge={key:0,class:"offline-list__grid"},Ze={class:"offline-download-card__header"},We={class:"offline-download-card__thumbnail"},Je=["src"],Ke={key:1,class:"offline-download-card__thumbnail-placeholder"},Xe={class:"offline-download-card__duration"},et={class:"offline-download-card__body"},tt={class:"offline-download-card__title"},at={class:"offline-download-card__meta"},ot={class:"offline-download-card__chips"},lt={key:0,class:"offline-download-card__progress"},st={class:"offline-download-card__progress-text"},rt={key:1,class:"offline-download-card__description"},nt={class:"offline-download-card__footer"},it={class:"offline-download-card__info"},dt={class:"offline-download-card__footer-actions"},ut={key:1,class:"offline-list__empty"},ct=_e({__name:"Index",setup(ft){const s=ve(),R=pe(),Z=ge(),W=ke(),Y=c(!0),b=c(!1),H=c("newest"),z=c(""),V=c(!1),U=c(null),D=c(R.settings.video_streaming_quality),g=c(!1),w=c(!0),y=c(!1),$=c(null),k=c(new Map),h=O(()=>Ie.isHEVCVideoSupported()),J=[{title:"新しい順",value:"newest"},{title:"古い順",value:"oldest"},{title:"ダウンロード中",value:"downloading"},{title:"完了済み",value:"completed"}],N=a=>{switch(a){case"1080p-60fps":return"1080p (60fps)";case"1080p":return"1080p";case"810p":return"810p";case"720p":return"720p";case"540p":return"540p";case"480p":return"480p";case"360p":return"360p";case"240p":return"240p";default:return a}},K=Ve.map(a=>({label:N(a),value:a})),C=async()=>(s.initialized===!1&&await s.initialize(),s.initialization_error!==null?(v.error(s.initialization_error),!1):!0),B=O(()=>{let a=[...s.downloads];const t=z.value.trim().toLowerCase();switch(t.length>0&&(a=a.filter(e=>[e.recorded_program.title,e.recorded_program.description,e.recorded_program.channel_name].join(" ").toLowerCase().includes(t))),H.value){case"newest":return a.sort((e,r)=>new Date(r.created_at).getTime()-new Date(e.created_at).getTime());case"oldest":return a.sort((e,r)=>new Date(e.created_at).getTime()-new Date(r.created_at).getTime());case"downloading":return a.filter(e=>e.status==="downloading").sort((e,r)=>new Date(r.updated_at).getTime()-new Date(e.updated_at).getTime());case"completed":return a.filter(e=>e.status==="completed").sort((e,r)=>new Date(r.updated_at).getTime()-new Date(e.updated_at).getTime());default:return a}}),X=O(()=>{const a=s.downloads.reduce((t,e)=>t+e.downloaded_bytes,0);return x.formatBytes(a)}),M=a=>s.progress[a.id],ee=a=>{if(a.status==="completed")return 100;const t=M(a);return t===void 0||t.total_segments===0?0:Math.min(100,Math.round(t.downloaded_segments/t.total_segments*100))},te=a=>{const t=M(a),e=(t==null?void 0:t.total_segments)??a.segment_count;return e===0?"":`${(t==null?void 0:t.downloaded_segments)??(a.status==="completed"?e:0)} / ${e} セグメント`},ae=a=>{const t=M(a),e=(t==null?void 0:t.downloaded_bytes)??a.downloaded_bytes,r=(t==null?void 0:t.total_bytes_estimated)??a.total_size,me=r>0?x.formatBytes(r):"--";return`${x.formatBytes(e)} / ${me}`},oe=a=>x.formatBytes(a.downloaded_bytes),le=a=>{switch(a){case"downloading":return"ダウンロード中";case"completed":return"保存済み";case"paused":return"停止中";case"error":return"エラー";default:return a}},se=(a,t)=>{const e=E(a),r=E(t);return`${e.format("YYYY/MM/DD HH:mm")} - ${r.format("HH:mm")}`},re=a=>{const t=Math.floor(a/3600),e=Math.floor(a%3600/60);return t>0?`${t}時間${e}分`:`${e}分`},ne=a=>E(a).format("YYYY/MM/DD HH:mm"),ie=a=>{if(a.status!=="completed"){v.info("ダウンロードが完了すると再生できます。");return}W.push({path:`/offline/watch/${a.id}`}).catch(()=>{})},de=a=>{U.value=a,D.value=a.quality,g.value=h.value&&a.is_hevc,w.value=a.save_comments??!0,V.value=!0},F=()=>{V.value=!1,U.value=null,y.value=!1},ue=async()=>{const a=U.value;if(!(a===null||!await C())){y.value=!0;try{const e=await ze.fetchVideo(a.video_id);if(e===null){v.error("録画番組情報を取得できませんでした。");return}a.status==="downloading"&&L.cancelDownload(a.id),await I.removeDownload(a),s.removeDownload(a.id),await s.refreshDownloads(),await L.startDownload(e,{quality:D.value,isHevc:g.value,saveComments:w.value}),v.success("再獲得を開始しました。"),F()}catch(e){console.error("[OfflineIndex] Failed to re-download offline data.",e),v.error("再獲得の開始に失敗しました。")}finally{y.value=!1}}},ce=async a=>{if(!(window.confirm("オフライン保存したデータを削除しますか？")===!1||!await C())){a.status==="downloading"&&L.cancelDownload(a.id),$.value=a.id;try{await I.removeDownload(a),s.removeDownload(a.id),await s.refreshDownloads(),v.success("オフラインデータを削除しました。")}catch(e){console.error("[OfflineIndex] Failed to remove offline data.",e),v.error("オフラインデータの削除に失敗しました。")}finally{$.value=null}}},fe=async()=>{if(await C()){b.value=!0;try{await s.refreshDownloads(),await j()}finally{b.value=!1}}},j=async()=>{for(const a of k.value.values())URL.revokeObjectURL(a);k.value.clear();for(const a of s.downloads)if(a.has_thumbnail===!0)try{const t=await I.getThumbnailDataUrl(a.id);t!==null&&k.value.set(a.id,t)}catch(t){console.warn(`[OfflineIndex] Failed to load thumbnail for ${a.id}`,t)}},q=a=>k.value.get(a.id)??null;return we(async()=>{await Z.fetchUser(),await C()&&(await s.refreshDownloads(),await j()),h.value===!0&&(g.value=R.settings.video_data_saver_mode===!0),Y.value=!1}),(a,t)=>(u(),d(P,null,[l("div",Ee,[o(Te),l("main",null,[o(Se),l("div",Le,[o(He),l("div",Re,[o(xe,{crumbs:[{name:"ホーム",path:"/"},{name:"オフライン保存",path:"/offline/",disabled:!0}]}),l("section",Ye,[l("div",Ne,[t[7]||(t[7]=l("h1",null,"オフライン保存",-1)),o(S,{size:"small",color:"primary",variant:"tonal"},{default:n(()=>[m(" 合計 "+i(f(s).downloads.length)+" 件 ",1)]),_:1})]),l("div",Fe,[o(Ue,{modelValue:z.value,"onUpdate:modelValue":t[0]||(t[0]=e=>z.value=e),placeholder:"番組を検索...",density:"comfortable",variant:"outlined","hide-details":"",clearable:"",class:"offline-toolbar__search","bg-color":"background-lighten-1"},{"prepend-inner":n(()=>[o(f(_),{icon:"fluent:search-12-regular",width:"18",class:"text-text-darken-1"})]),_:1},8,["modelValue"]),o(Q,{modelValue:H.value,"onUpdate:modelValue":t[1]||(t[1]=e=>H.value=e),items:J,"item-title":"title","item-value":"value","hide-details":"",density:"comfortable",variant:"solo","bg-color":"background-lighten-1",class:"offline-toolbar__sort"},null,8,["modelValue"]),o(p,{size:"small",variant:"text",color:"primary",loading:b.value,disabled:b.value,onClick:fe},{default:n(()=>[o(f(_),{icon:"fluent:arrow-sync-12-regular",width:"18",class:"mr-1"}),t[8]||(t[8]=m(" 再読み込み ",-1))]),_:1},8,["loading","disabled"])])]),f(s).initialization_error?(u(),d("section",je,[o(ye,{type:"error",variant:"tonal"},{default:n(()=>[m(i(f(s).initialization_error),1)]),_:1})])):T("",!0),B.value.length>0?(u(),d("section",qe,[o(f(_),{icon:"fluent:database-20-regular",width:"18",class:"mr-2"}),l("span",null,"ストレージ使用量: "+i(X.value),1)])):T("",!0),l("section",Ae,[Y.value?(u(),d("div",Qe,[o(he,{indeterminate:"",size:"36",color:"primary"})])):(u(),d(P,{key:1},[B.value.length>0?(u(),d("div",Ge,[(u(!0),d(P,null,be(B.value,e=>(u(),d("article",{key:e.id,class:"offline-download-card"},[l("div",Ze,[l("div",We,[q(e)?(u(),d("img",{key:0,src:q(e),alt:"サムネイル",class:"offline-download-card__thumbnail-image"},null,8,Je)):(u(),d("div",Ke,[o(f(_),{icon:"fluent:video-20-regular",width:"42"})])),l("span",Xe,i(re(e.recorded_program.duration)),1),l("span",{class:A(["offline-download-card__status",`offline-download-card__status--${e.status}`])},i(le(e.status)),3)]),o(p,{variant:"tonal",color:"primary",size:"small",class:"offline-download-card__play",disabled:e.status!=="completed",onClick:r=>ie(e)},{default:n(()=>[o(f(_),{icon:"fluent:play-16-regular",width:"18",class:"mr-1"}),t[9]||(t[9]=m(" 再生 ",-1))]),_:1},8,["disabled","onClick"])]),l("div",et,[l("h2",tt,i(e.recorded_program.title),1),l("div",at,[l("span",null,i(se(e.recorded_program.start_time,e.recorded_program.end_time)),1),l("span",null,"・"+i(e.recorded_program.channel_name),1)]),l("div",ot,[o(S,{size:"x-small",variant:"tonal"},{default:n(()=>[m(i(N(e.quality)),1)]),_:2},1024),o(S,{size:"x-small",variant:"tonal"},{default:n(()=>[m(i(e.is_hevc?"HEVC":"H.264"),1)]),_:2},1024),o(S,{size:"x-small",variant:"tonal"},{default:n(()=>[m(i(e.save_comments?"コメントあり":"コメントなし"),1)]),_:2},1024)]),e.status==="downloading"?(u(),d("div",lt,[o(De,{"model-value":ee(e),height:"8",rounded:"",color:"primary"},null,8,["model-value"]),l("div",st,[l("span",null,i(te(e)),1),l("span",null,i(ae(e)),1)])])):T("",!0),e.recorded_program.description?(u(),d("p",rt,i(e.recorded_program.description),1)):T("",!0)]),l("div",nt,[l("div",it,[l("span",null,"サイズ: "+i(oe(e)),1),l("span",null,"更新: "+i(ne(e.updated_at)),1)]),l("div",dt,[o(p,{size:"small",variant:"outlined",color:"primary",class:"offline-download-card__action",onClick:r=>de(e)},{default:n(()=>[o(f(_),{icon:"fluent:arrow-clockwise-16-regular",width:"16",class:"mr-1"}),t[10]||(t[10]=m(" 再獲得 ",-1))]),_:1},8,["onClick"]),o(p,{size:"small",variant:"text",color:"error",class:"offline-download-card__action",loading:$.value===e.id,onClick:r=>ce(e)},{default:n(()=>[o(f(_),{icon:"fluent:delete-20-regular",width:"18",class:"mr-1"}),t[11]||(t[11]=m(" 削除 ",-1))]),_:1},8,["loading","onClick"])])])]))),128))])):(u(),d("div",ut,[o(f(_),{icon:"fluent:arrow-download-24-regular",width:"42"}),t[12]||(t[12]=l("p",null,"まだオフライン保存した番組がありません。",-1)),t[13]||(t[13]=l("p",null,"録画番組の詳細から「オフライン保存」を選択してください。",-1))]))],64))])])])])]),o($e,{modelValue:V.value,"onUpdate:modelValue":t[6]||(t[6]=e=>V.value=e),"max-width":"420"},{default:n(()=>[o(Be,null,{default:n(()=>[o(Me,{class:"text-subtitle-1 font-weight-bold"},{default:n(()=>[...t[14]||(t[14]=[m(" 再獲得の設定 ",-1)])]),_:1}),o(Oe,null,{default:n(()=>[t[15]||(t[15]=l("p",{class:"offline-dialog__description"}," 保存する画質とオプションを選択してください。既存のデータを削除して再度ダウンロードします。 ",-1)),o(Q,{modelValue:D.value,"onUpdate:modelValue":t[2]||(t[2]=e=>D.value=e),items:f(K),"item-title":"label","item-value":"value",label:"保存する画質",density:"comfortable",variant:"outlined"},null,8,["modelValue","items"]),o(G,{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=e=>g.value=e),class:"mt-2",color:"primary","hide-details":"",inset:"",disabled:!h.value,label:h.value?"HEVC (H.265) を使用する":"HEVC (H.265) を使用できません"},null,8,["modelValue","disabled","label"]),l("p",{class:A(["offline-dialog__hint",{"offline-dialog__hint--disabled":!h.value}])}," HEVC は同じ画質でもファイルサイズを抑えられますが、非対応端末では再生できません。 ",2),o(G,{modelValue:w.value,"onUpdate:modelValue":t[4]||(t[4]=e=>w.value=e),class:"mt-3",color:"primary","hide-details":"",inset:"",label:w.value?"コメントも保存する":"コメントは保存しない"},null,8,["modelValue","label"]),t[16]||(t[16]=l("p",{class:"offline-dialog__hint offline-dialog__hint--secondary"}," コメントを保存すると、オフライン再生時に実況コメントを確認できます。 ",-1))]),_:1}),o(Pe,{class:"justify-end"},{default:n(()=>[o(p,{variant:"text",disabled:y.value,onClick:t[5]||(t[5]=e=>F())},{default:n(()=>[...t[17]||(t[17]=[m(" キャンセル ",-1)])]),_:1},8,["disabled"]),o(p,{variant:"flat",color:"primary",loading:y.value,onClick:ue},{default:n(()=>[...t[18]||(t[18]=[m(" 再獲得を開始 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}}),zt=Ce(ct,[["__scopeId","data-v-b4217bad"]]);export{zt as default};
